<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>uniapp | 尚硅谷</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/MINI/assets/css/0.styles.190f7eeb.css" as="style"><link rel="preload" href="/MINI/assets/js/app.bdc84bd3.js" as="script"><link rel="preload" href="/MINI/assets/js/12.4f167973.js" as="script"><link rel="prefetch" href="/MINI/assets/js/10.f2ba735c.js"><link rel="prefetch" href="/MINI/assets/js/11.ec61c9cd.js"><link rel="prefetch" href="/MINI/assets/js/13.a4c311e7.js"><link rel="prefetch" href="/MINI/assets/js/14.6eafeaba.js"><link rel="prefetch" href="/MINI/assets/js/15.f1cb3d61.js"><link rel="prefetch" href="/MINI/assets/js/16.f96adbde.js"><link rel="prefetch" href="/MINI/assets/js/17.ca2be00d.js"><link rel="prefetch" href="/MINI/assets/js/18.10411fd0.js"><link rel="prefetch" href="/MINI/assets/js/19.04f47194.js"><link rel="prefetch" href="/MINI/assets/js/2.d8f505d4.js"><link rel="prefetch" href="/MINI/assets/js/20.3d82626a.js"><link rel="prefetch" href="/MINI/assets/js/21.468954f2.js"><link rel="prefetch" href="/MINI/assets/js/3.cf7971e6.js"><link rel="prefetch" href="/MINI/assets/js/4.1374372d.js"><link rel="prefetch" href="/MINI/assets/js/5.7dc0ca99.js"><link rel="prefetch" href="/MINI/assets/js/6.1b731cb3.js"><link rel="prefetch" href="/MINI/assets/js/7.57df3f8b.js"><link rel="prefetch" href="/MINI/assets/js/8.0dd5f3d5.js"><link rel="prefetch" href="/MINI/assets/js/9.19615c49.js">
    <link rel="stylesheet" href="/MINI/assets/css/0.styles.190f7eeb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/MINI/" class="home-link router-link-active"><!----> <span class="site-name">尚硅谷</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/MINI/vx/" class="nav-link">vx</a></div><div class="nav-item"><a href="/MINI/uniapp/" class="nav-link router-link-active">uniapp</a></div><div class="nav-item"><a href="/MINI/interview/" class="nav-link">interview</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/MINI/vx/" class="nav-link">vx</a></div><div class="nav-item"><a href="/MINI/uniapp/" class="nav-link router-link-active">uniapp</a></div><div class="nav-item"><a href="/MINI/interview/" class="nav-link">interview</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>uniapp介绍</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/MINI/uniapp/01_uniapp简介.html" class="sidebar-link">uniapp介绍</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>第一章</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/MINI/uniapp/one.html" class="sidebar-link">uniapp</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>第二章</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/MINI/uniapp/two.html" class="sidebar-link">uniapp</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>第三章</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/MINI/uniapp/three.html" class="active sidebar-link">uniapp</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/MINI/uniapp/three.html#购物车总价的修改" class="sidebar-link">购物车总价的修改</a></li><li class="sidebar-sub-header"><a href="/MINI/uniapp/three.html#购物车选中的数量" class="sidebar-link">购物车选中的数量</a></li><li class="sidebar-sub-header"><a href="/MINI/uniapp/three.html#购物车单选状态" class="sidebar-link">购物车单选状态</a></li><li class="sidebar-sub-header"><a href="/MINI/uniapp/three.html#购物车全选状态" class="sidebar-link">购物车全选状态</a></li><li class="sidebar-sub-header"><a href="/MINI/uniapp/three.html#修改数量" class="sidebar-link">修改数量</a></li><li class="sidebar-sub-header"><a href="/MINI/uniapp/three.html#授权登录流程" class="sidebar-link">授权登录流程</a></li><li class="sidebar-sub-header"><a href="/MINI/uniapp/three.html#code-openid-token-jwt" class="sidebar-link">code&amp;&amp;openid&amp;&amp;token(JWT)</a></li><li class="sidebar-sub-header"><a href="/MINI/uniapp/three.html#支付流程" class="sidebar-link">支付流程</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="uniapp"><a href="#uniapp" aria-hidden="true" class="header-anchor">#</a> uniapp</h1> <p></p><div class="table-of-contents"><ul><li><a href="#购物车总价的修改">购物车总价的修改</a></li><li><a href="#购物车选中的数量">购物车选中的数量</a></li><li><a href="#购物车单选状态">购物车单选状态</a></li><li><a href="#购物车全选状态">购物车全选状态</a></li><li><a href="#修改数量">修改数量</a></li><li><a href="#授权登录流程">授权登录流程</a></li><li><a href="#code-openid-token-jwt">code&amp;&amp;openid&amp;&amp;token(JWT)</a></li><li><a href="#支付流程">支付流程</a><ul><li><a href="#重要步骤">重要步骤</a></li></ul></li></ul></div><p></p> <h2 id="购物车总价的修改"><a href="#购物车总价的修改" aria-hidden="true" class="header-anchor">#</a> 购物车总价的修改</h2> <ul><li>计算总价</li> <li>1、数据全部在<code>shopCartList</code></li> <li>2、计算数据添加 用数组的<code>reduce</code>处理</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>totalPrice<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>合计: {{allMoney}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token function">allMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>shopCartList<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span>item</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>isChecked<span class="token punctuation">)</span><span class="token punctuation">{</span>
			prev <span class="token operator">+=</span> item<span class="token punctuation">.</span>counterPrice <span class="token operator">*</span> item<span class="token punctuation">.</span>count
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> prev
	<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="购物车选中的数量"><a href="#购物车选中的数量" aria-hidden="true" class="header-anchor">#</a> 购物车选中的数量</h2> <ul><li>计算选中商品的数量</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>allSelected<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>已选 {{checkedNum}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token function">checkedNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>shopCartList<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span>item</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>isChecked<span class="token punctuation">)</span><span class="token punctuation">{</span>
			prev <span class="token operator">+=</span> item<span class="token punctuation">.</span>count
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> prev
	<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="购物车单选状态"><a href="#购物车单选状态" aria-hidden="true" class="header-anchor">#</a> 购物车单选状态</h2> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>iconfont icon-xuanzhong<span class="token punctuation">'</span></span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{selected: item.isChecked}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>singleCheck(item)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
methods<span class="token punctuation">:</span><span class="token punctuation">{</span>
	<span class="token function">singleCheck</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		item<span class="token punctuation">.</span>isChecked <span class="token operator">=</span> <span class="token operator">!</span>item<span class="token punctuation">.</span>isChecked 
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="购物车全选状态"><a href="#购物车全选状态" aria-hidden="true" class="header-anchor">#</a> 购物车全选状态</h2> <ul><li>计算全选状态 利用数组的<code>every</code>方法</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>iconfont icon-xuanzhong<span class="token punctuation">'</span></span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{selected: isAllChecked}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>changeIsCheckAll<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
methods<span class="token punctuation">:</span><span class="token punctuation">{</span>
	<span class="token function">changeIsCheckAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">const</span> isAllChecked <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isAllChecked
		<span class="token keyword">this</span><span class="token punctuation">.</span>shopCartList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			item<span class="token punctuation">.</span>isChecked <span class="token operator">=</span> <span class="token operator">!</span>isAllChecked
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
computed<span class="token punctuation">:</span><span class="token punctuation">{</span>
	<span class="token function">isAllChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>shopCartList<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>isChecked<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="修改数量"><a href="#修改数量" aria-hidden="true" class="header-anchor">#</a> 修改数量</h2> <ul><li>当减少数量的时候,如果减少到0,要弹出模态框,确定需要删除购物车</li> <li><code>uni.showModal</code> 提示弹出</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>countCtrl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>add<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>changeNum(item,'add')<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> + <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>count<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{item.count}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>del<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>changeNum(item,'del', index)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> - <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
methods<span class="token punctuation">:</span><span class="token punctuation">{</span>
	<span class="token function">changeNum</span><span class="token punctuation">(</span><span class="token parameter">cart<span class="token punctuation">,</span>type<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'add'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				cart<span class="token punctuation">.</span>count <span class="token operator">++</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span>count <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					cart<span class="token punctuation">.</span>count <span class="token operator">--</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					uni<span class="token punctuation">.</span><span class="token function">showModal</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
						title<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`你确定要删除</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cart<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">吗`</span></span><span class="token punctuation">,</span>
						<span class="token function-variable function">success</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
							<span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>confirm<span class="token punctuation">)</span><span class="token punctuation">{</span>
								<span class="token comment">// 用户点击了确定按钮</span>
								<span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'DELE_SHOPCART'</span><span class="token punctuation">,</span>index<span class="token punctuation">)</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">}</span> 
					<span class="token punctuation">}</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- store/shopcart.js --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">const</span> mutations <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token constant">DELE_SHOPCART</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		state<span class="token punctuation">.</span>shopCartList<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="授权登录流程"><a href="#授权登录流程" aria-hidden="true" class="header-anchor">#</a> 授权登录流程</h2> <ul><li>唯一标识，openId用于获取用户隐私数据（支付等等相关）</li> <li>第一步：wx.login获取code
<ul><li>在个人中心mouted的时候去wx.login获取code</li></ul></li> <li>第二步：发送code给自己的服务器</li> <li>第三步：自己的服务器通过code + appId + appsecret 请求微信服务器换取用户唯一标识 （通过flyIo包发送请求）</li> <li>第四步：返回的标识在服务器端，我们可以给唯一标识加密 （jsonwebtoken包）</li> <li>第五步：自己的服务器加密完成的东西，就是我们的token可以自己使用</li> <li>第六步：用户发请求，我们都会在服务器进行token的解密，获取用户的openId，然后对比返回用户的信息
<img src="/MINI/img/wxlogin.jpg"></li></ul> <h2 id="code-openid-token-jwt"><a href="#code-openid-token-jwt" aria-hidden="true" class="header-anchor">#</a> code&amp;&amp;openid&amp;&amp;token(JWT)</h2> <ul><li><p><a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html" target="_blank" rel="noopener noreferrer"><code>code</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 用户登录凭证（有效期五分钟,开发者需要在开发者服务器后台调用相应的接口,在<code>wx.login</code>的回调中获取,用来换取<code>openid</code>,<code>session_key</code>等信息</p></li> <li><p><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html" target="_blank" rel="noopener noreferrer"><code>openid</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>通过下面的接口换取</p> <ul><li>url:<code>GET https://api.weixin.qq.com/sns/jscode2session?appid=APPID&amp;secret=SECRET&amp;js_code=JSCODE&amp;grant_type=authorization_code</code></li> <li>method:<code>GET</code></li> <li>query:<code>appid</code>,<code>secret</code>,<code>js_code</code> 查找=&gt; 登录微信公众平台【开发】=&gt; 【开发管理】=&gt;【开发设置】=&gt;【开发者ID】</li></ul></li> <li><p>token(JWT)</p> <div class="tip custom-block"><p class="custom-block-title">token</p> <p>jwt token = base64 URL(头部) + &quot;.&quot; +base64 URL(负载) + &quot;.&quot; + base64 URL(签名)</p></div> <ul><li>token 的中文意思是&quot;令牌&quot;。主要用来身份验证。</li> <li>JWT 是token的一种实现方式</li> <li>头部:	通常包含了两部分：token类型和采用的加密算法。{ &quot;alg&quot;: &quot;HS256&quot;, &quot;typ&quot;: &quot;JWT&quot;}</li> <li>负载:	就是存放有效信息的地方(账号密码过期时间等等)</li> <li>签名:	需要指定一个密钥(secretKey)，该密钥只存在服务器中，不能向用户公开公开，使用header中指定的签名算法生成签名。</li></ul></li> <li><p>登录页面</p> <ul><li><a href="https://uniapp.dcloud.net.cn/api/plugins/login.html#login" target="_blank" rel="noopener noreferrer"><code>uni.login</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 等于 <code>wx.login</code></li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	uni<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
		<span class="token function-variable function">success</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> res<span class="token punctuation">;</span>
			<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`/getOpenId?code=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>服务端</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//这个接口是用来获取客户端发送过来的code,进而获取唯一标识openId的</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/getOpenId'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token comment">//第一步：接收到code</span>
	<span class="token keyword">let</span> code <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>code
	<span class="token keyword">let</span> appId <span class="token operator">=</span> <span class="token string">'wx325e30f6ed61456a'</span>
	<span class="token keyword">let</span> secret <span class="token operator">=</span> <span class="token string">'107cd38f52f6ee1b2122b9131d0e65f1'</span>
	
	<span class="token comment">//第二步：获取到code之后，我们需要用code 和 appId 和 秘钥 发请求给微信服务器，获取openId</span>
	<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> fly<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`https://api.weixin.qq.com/sns/jscode2session?appid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;secret=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>secret<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;js_code=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;grant_type=authorization_code`</span></span><span class="token punctuation">)</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
	<span class="token comment">// ctx.body = result.data  我们一般不会把隐私数据名文给了用户，而是需要加密后给用户（变为token）</span>
	
	<span class="token comment">//第三步：自己制作一个jwt，返回给用户作为用户的唯一标识（jwt用什么都可以加密生成，最好是当前请求过来客户端用户的信息）</span>
	<span class="token keyword">let</span> token <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">,</span><span class="token string">'zhaoliying'</span><span class="token punctuation">)</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
	ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> token
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="支付流程"><a href="#支付流程" aria-hidden="true" class="header-anchor">#</a> 支付流程</h2> <ul><li><a href="https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter2_8_2.shtml" target="_blank" rel="noopener noreferrer">文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <img src="/MINI/img/wxplay.png"></li></ul> <h3 id="重要步骤"><a href="#重要步骤" aria-hidden="true" class="header-anchor">#</a> 重要步骤</h3> <ul><li>【步骤4】用户下单发起支付，商户可通过<a href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_1.shtml" target="_blank" rel="noopener noreferrer">JSAPI<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>下单创建支付订单。</li> <li>【步骤9】商户小程序内使用<a href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_4.shtml" target="_blank" rel="noopener noreferrer">小程序调起支付API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（wx.requestPayment）发起微信支付，详见小程序API文档</li> <li>【步骤16】用户支付成功后，商户可接收到微信支付支付结果通知<a href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_5.shtml" target="_blank" rel="noopener noreferrer">支付通知API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li>【步骤21】商户在没有接收到微信支付结果通知的情况下需要主动调用<a href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_2.shtml" target="_blank" rel="noopener noreferrer">查询订单API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>查询支付结果。</li></ul></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">11/12/2022, 2:07:37 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/MINI/uniapp/two.html" class="prev">
          uniapp
        </a></span> <!----></p></div> </div> <!----></div></div>
    <script src="/MINI/assets/js/app.bdc84bd3.js" defer></script><script src="/MINI/assets/js/12.4f167973.js" defer></script>
  </body>
</html>
